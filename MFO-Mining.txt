initEvents ; Command needed to initialize events
 
gosub Initialize
 
gosub MineCircle
gosub WeightCheck
gosub DumpOre
gosub ConsolidateOre %IronCol
gosub ConsolidateOre %DullCopperCol
gosub ConsolidateOre %ShadowCol
gosub ConsolidateOre %CopperCol
If %UsePackHorse = #True
   gosub LoadHorse
Halt
 
 
Sub Initialize
    Set %MiningTool QPF_TWF ; Mining tools (i.e., pickaxe or shovel) *Type
    Set %ToolBag GDWGMMD ; Bag to store mining tools *ID
 
    Set %Ore TVJ_TWF_DWJ_EWJ_GWJ ; Object types for raw ore *Type
    Set %IronCol 0
    Set %DullCopperCol 2419
    Set %ShadowCol 2406
    Set %CopperCol 2413
    Set %BronzeCol 2418
    Set %GoldCol 2213
    Set %AgapiteCol 2425
    Set %VeriteCol 2207
    Set %ValoriteCol 2219
 
    Set %UsePackHorse #True
    Set %PackHorse ZGFMMMD
 
    Set %FindCnt 1
    While #FindCnt <> 0
    {
        FindItem %MiningTool C_ , #BackpackID ; Find mining tools in main backpack
        ExEvent Drag #FindID 1 ; Pick up mining tools
        Wait 10
        ExEvent DropC %ToolBag ; Drop tools in specified container
        Wait 15
    }
    gosub MiningToolCheck
    Return
 
Sub MiningToolCheck ; Mining tool interrupt
    FindItem %MiningTool C
    Set #LObjectID #FindID
   
    If #FindKind -1
    {
        Display You have run out of mining tools, script halting.
        Halt
    }
    Return
 
Sub MineCircle
    for %y -1 1 ; y-axis
    {
        For %x -1 1 ; x-axis
        {
            Set #LTargetKind 2
            Set #LTargetX #CharPosX + %x
            Set #LTargetY #CharPosY + %y
            Set #LTargetZ #CharPosZ
 
            Set %MineTrigger #True
            While %MineTrigger <> #False
            {
                If You_have_worn_out_your_tool! in #SysMsg
                    gosub MiningToolCheck
 
                Event Macro 17 0 ; LastObject
                Target
                Event Macro 22 0 ; LastTarget
                Wait 15
                If There_is_no_metal_here in #sysMsg || You_can't_mine_that in #sysMsg || That_is_too_far_away in #sysMsg || You_can't_mine_there in #sysMsg
                    Set %MineTrigger #False
            }
        }
    }
    Return
 
Sub WeightCheck
    Set %WeightTrigger #MaxWeight - 20
    If #Weight < %WeightTrigger
        Halt
    Return
   
Sub DumpOre
    FindItem %Ore G_3
    Set %DropX #CharPosX + 1
    Set %DropY #CharPosY + 1
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID #FindStack
        Wait 10
        ExEvent DropG %DropX %DropY #CharPosZ
        Wait 10
    }
 
    FindItem %Ore C_ , #BackpackID
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID #FindStack
        Wait 10
        ExEvent DropG %DropX %DropY #CharPosZ
        Wait 10
    }
    If %UsePackHorse = #True
        Event Macro 1 0 All Come
    Return
 
Sub ConsolidateOre
    FindItem %Ore G_3
    For #FindIndex 1 #FindCnt
    {
        If #FindCol = %1
        {
            Set #LTargetID #FindID
            Set #LTargetKind 1
        }
    }
 
    For #FindIndex 1 #FindCnt
        {
            If #FindCol = %1
            {
                If #FindID <> #LTargetID
                {
                    Set #LObjectID #FindID
                    Event Macro 17 0
                    Target
                    Event Macro 22 0
                    Wait 1s
                }
            }
        }
    }
    Return
   
Sub LoadHorse
    Wait 1s
    FindItem %Ore G_3
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID #FindStack
        Wait 10
        ExEvent DropC %PackHorse
        Wait 10
    }
    Event Macro 1 0 All Stay
    Return