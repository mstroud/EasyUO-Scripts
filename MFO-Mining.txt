initEvents ; Command needed to initialize events
 
gosub Initialize
 
gosub MineCircle
gosub DumpOre
gosub ConsolidateOre %IronCol
gosub ConsolidateOre %DullCopperCol
gosub ConsolidateOre %ShadowCol
If %UsePackHorse = 1
   gosub LoadHorse
 
Display Node Exhausted & Ore Sorted!
Halt
 
 
Sub Initialize
    Set %MiningTool QPF_TWF ; Mining tools (i.e., pickaxe or shovel) *Type
    Set %ToolBag GDWGMMD ; Bag to store mining tools *ID
 
    Set %Ore TVJ_TWF_DWJ_EWJ_GWJ ; Object types for raw ore *Type
    Set %IronCol 0
    Set %DullCopperCol 2419
    Set %ShadowCol 2406
 
    Set %UsePackHorse #False
    Set %PackHorse LFAKMMD
 
    Set %FindCnt 1
 
    While #FindCnt <> 0
    {
        FindItem %MiningTool C_ , #BackpackID ; Find mining tools in main backpack
        ExEvent Drag #FindID 1 ; Pick up mining tools
        Wait 5
        ExEvent DropC %ToolBag ; Drop tools in specified container
        Wait 5
    }
    gosub MiningToolCheck
    Return
 
Sub MiningToolCheck ; Mining tool interrupt
    FindItem %MiningTool C
    Set #LObjectID #FindID
   
    If #FindKind -1
    {
        Display You have run out of mining tools, script halting.
        Halt
    }
    Return
 
Sub MineCircle
    for %y 0 2 ; y-axis
    {
        For %x 0 2 ; x-axis
        {
            Set %MineTrigger #True
            While %MineTrigger <> #False
            {
                If You_have_worn_out_your_tool! in #SysMsg
                    gosub MiningToolCheck
                Set %DigX %x * 35 + 365 ; Delta + Quadrant 1 screen coords (Top left of player)
                Set %DigY %y * 30 + 270
                Event Macro 17 0 ; LastObject
                Target
                Click %DigX %DigY
                Wait 15
                If There_is_no_metal_here in #sysMsg || You_can't_mine_that. in #sysMsg || That_is_too_far_away. in #sysMsg
                    Set %MineTrigger #False
            }
        }
    }
    Return
   
Sub WeightCheck
    Set %WeightTrigger #MaxWeight - 20
    If #Weight > %WeightTrigger
    {
        Display Weight near limit, halting script.
        Halt
    }
    Return
   
Sub DumpOre
    FindItem %Ore G_3
    For #FindIndex 1 #FindCnt
    {
        FindItem %Ore G_3
        If #FindCol = %IronCol
        {
            Set %DropX #CharPosX
            Set %DropY #CharPosY + 2
        }
        If #FindCol = %DullCopperCol
        {
            Set %DropX #CharPosX + 1
            Set %DropY #CharPosY + 1
        }
        If #FindCol = %ShadowCol
        {
            Set %DropX #CharPosX + 2
            Set %DropY #CharPosY
        }
        ExEvent Drag #FindID #FindStack
        Wait 10
        ExEvent DropG %DropX %DropY #CharPosZ
        Wait 10
    }
 
    FindItem %Ore C_ , #BackpackID
    While #FindCnt <> 0
    {
        FindItem %Ore C_ , #BackpackID
        If #FindCol = %IronCol
        {
            Set %DropX #CharPosX
            Set %DropY #CharPosY + 2
        }
        If #FindCol = %DullCopperCol
        {
            Set %DropX #CharPosX + 1
            Set %DropY #CharPosY + 1
        }
        If #FindCol = %ShadowCol
        {
            Set %DropX #CharPosX + 2
            Set %DropY #CharPosY
        }
        ExEvent Drag #FindID #FindStack
        Wait 10
        ExEvent DropG %DropX %DropY #CharPosZ
        Wait 10
    }
    If %UsePackHorse = 1
        Event Macro 1 0 All Come
    Return
 
Sub ConsolidateOre
    FindItem %Ore G_3
    For #FindIndex 1 #FindCnt
    {
        If #FindCol = %1
        {
            Set #LTargetID #FindID
            Set #LTargetKind 1
        }
    }
 
    For #FindIndex 1 #FindCnt
        {
            If #FindCol = %1
            {
                If #FindID <> #LTargetID
                {
                    Set #LObjectID #FindID
                    Event Macro 17 0
                    Target
                    Event Macro 22 0
                    Wait 1s
                }
            }
        }
    }
    Return
   
Sub LoadHorse
    Wait 1s
    FindItem %Ore G_3
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID #FindStack
        Wait 10
        ExEvent DropC %PackHorse
        Wait 10
    }
    Event Macro 1 0 All Stay
    Return