GoSub Initialize
GoSub MiningToolInit
GoSub CreateMenu

Mainloop:
    If #menuButton = Mine
    {
        GoSub MineCircle
        Set #menuButton Nothing

    }
    If #menuButton = Smelt
    {
        GoSub Smelt
        Set #menuButton Nothing
    }
    If #menuButton = Quit
    {
        menu Hide
        Halt
    }
    If #menuButton = Consolidate
    {
        GoSub DumpOre
        gosub ConsolidateOre %IronCol
        gosub ConsolidateOre %DullCopperCol
        gosub ConsolidateOre %ShadowCol
        gosub ConsolidateOre %CopperCol
        ;gosub ConsolidateOre %BronzeCol
        ;gosub ConsolidateOre %GoldCol
        ;gosub ConsolidateOre %AgapiteCol
        ;gosub ConsolidateOre %VeriteCol
        ;gosub ConsolidateOre %ValoriteCol
        If %UsePackHorse = #True
            GoSub LoadHorse
        Set #menuButton Nothing
    }
    If #menuButton = LoadHorse
    {
        GoSub LoadHorse
        Set #menuButton Nothing
    }
    If #menuButton = Follow
    {
        Event Macro 1 0 All Follow Me
        Set #menuButton Nothing
    }
    If #menuButton = Stay
    {
        Event Macro 1 0 All Stay
        Set #menuButton Nothing
    }
    GoSub 8x8
    Goto Mainloop

Sub Initialize ; Initialize Global Variables and Starting Checks
    Menu Window Size 320 115
    Menu Window Title Mining Assist Suite_v1.1
    Menu Text Init 10 85 Initializing...
    Menu Show
    Set %EvDelay 15 ; Event Delay
    Set %MiningTool QPF_TWF ; Mining Tool Object Types
    Set %MiningToolCount 0
    Set %ToolBag UYOYKMD ; Mining Tool Container ID

    Set %Ore TVJ_DWJ_EWJ_GWJ ; Ore Object Types
    Set %Ingots ENK

    ; Ore Color Values
    Set %IronCol 0
    Set %DullCopperCol 2419
    Set %ShadowCol 2406
    Set %CopperCol 2413
    Set %BronzeCol 2418
    Set %GoldCol 2213
    Set %AgapiteCol 2425
    Set %VeriteCol 2207
    Set %ValoriteCol 2219

    Set %UsePackHorse #True ; Set #True if You're Using a Pack Horse
    Set %PackHorse ZGFMMMD ; Pack Horse Container ID

    Set #LObjectID #BackpackID
    Event Macro 17 0 ; Open Main Backpack
    Wait %EvDelay

    Set #LObjectID %ToolBag
    Event Macro 17 0 ; Open Mining Tool Bag
    Wait %EvDelay
    Return

Sub MiningToolInit
    GoSub MiningToolCheck
    FindItem %MiningTool C_ , #BackpackID ; Find Mining Tools in Main Backpack
    Wait 5
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID 1 ; Drag Mining Tool
        Wait %EvDelay
        ExEvent DropC %ToolBag 0 0; Drop Mining Tool in Mining Tool Bag
        Wait %EvDelay
    }
    Return

Sub CreateMenu
    Menu Clear
    Menu Font Align Center
    Menu Window Title Mining Assist Suite_v1.1
    Menu Button Mine 10 10 50 25 Mine
    Menu Button Smelt 70 10 50 25 Smelt
    Menu Button Consolidate 130 10 85 25 Consolidate
    Menu Button LoadHorse 225 10 85 25 Load Horse
    Menu Button Quit 260 80 50 25 Quit
    Menu Button Follow 10 40 145 35 Follow
    Menu Button Stay 165 40 145 35 Stay
    Menu Text MiningTools 10 85 Mining Tools: %MiningToolCount
    Menu Text XLabel 145 85 X:
    Menu Edit XLoc 160 80 20
    Menu Text YLabel 190 85 Y:
    Menu Edit YLoc 205 80 20
    Menu Show
    Return

Sub MiningToolCheck ; Mining tool interrupt
    FindItem %MiningTool C ; Find Mining Tool in any Open Containers
    Wait 5
    Set %MiningToolCount #FindCnt
    If #FindCnt = 0
    {
        Display You have run out of mining tools, script halting.
        menu Hide
        Halt
    }
    Set #LObjectID #FindID ; Set Mining Tool as Last Object
    menu Set MiningTools Mining Tools: %MiningToolCount
    Return

Sub MineCircle ; Mine Every Surrounding Tile
    GoSub MiningToolCheck
    For %y -1 1 ; y-axis
    {
        For %x -1 1 ; x-axis
        {
            If %x <> 0
            {
                If %y <> 0
                {
                    Set #LTargetKind 2
                    Set #LTargetX #CharPosX + %x
                    Set #LTargetY #CharPosY + %y
                    Set #LTargetZ #CharPosZ

                    Set %MineTrigger #True
                    While %MineTrigger <> #False
                    {
                        If You_have_worn_out_your_tool! in #SysMsg
                            gosub MiningToolCheck

                        Event Macro 17 0 ; LastObject
                        Target
                        Event Macro 22 0 ; LastTarget
                        Wait %EvDelay
                        If There_is_no_metal_here in #sysMsg || You_can't_mine_that in #sysMsg || That_is_too_far_away in #sysMsg || You_can't_mine_there in #sysMsg
                            Set %MineTrigger #False
                    }
                }
            }
        }
    }
    GoSub WeightCheck
    Return

Sub WeightCheck ; Check if Maximum Weight
    If #Weight > #MaxWeight
    {
        GoSub DumpOre
        gosub ConsolidateOre %IronCol
        gosub ConsolidateOre %DullCopperCol
        gosub ConsolidateOre %ShadowCol
        gosub ConsolidateOre %CopperCol
        ;gosub ConsolidateOre %BronzeCol
        ;gosub ConsolidateOre %GoldCol
        ;gosub ConsolidateOre %AgapiteCol
        ;gosub ConsolidateOre %VeriteCol
        ;gosub ConsolidateOre %ValoriteCol
        If %UsePackHorse = #True
            GoSub LoadHorse
    }
    Return
    
Sub DumpOre ; Dump All Ore From Open Packs
    FindItem %Ore C
    Wait 5
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID #FindStack
        Wait %EvDelay
        ExEvent DropG #CharPosX #CharPosY #CharPosZ
        Wait %EvDelay
    }
    If %UsePackHorse = #True
        Event Macro 1 0 All Come
    Return

Sub ConsolidateOre ; Comsolidate Ore Stacks on Ground by Type
    FindItem %Ore G_2
    Wait 5
    For #FindIndex 1 #FindCnt
    {
        If #FindCol = %1
        {
            Set #LTargetID #FindID
            Set #LTargetKind 1
        }
    }
    For #FindIndex 1 #FindCnt
        {
            If #FindCol = %1
            {
                If #FindID <> #LTargetID
                {
                    Set #LObjectID #FindID
                    Event Macro 17 0
                    Target
                    Event Macro 22 0
                    Wait %EvDelay
                }
            }
        }
    }
    Return
    
Sub LoadHorse ; Load Ore Stacks on Ground Into Pack Horse
    FindItem %Ore G_2
    Wait 5
    For #FindIndex 1 #FindCnt
    {
        ExEvent Drag #FindID #FindStack
        Wait %EvDelay
        ExEvent DropC %PackHorse
        Wait %EvDelay
    }
    Event Macro 1 0 All Stay
    Return
    
Sub Smelt
    Set %Forge JBG ; Forge Object Type
    FindItem %Forge G_2
    If #FindCnt >= 1
    {
         Set #LObjectID %PackHorse
         Event Macro 17 0
         Wait %EvDelay
         FindItem %Ore C_ , %PackHorse
         Wait 5
         For #FindIndex 1 #FindCnt
         {
             ExEvent Drag #FindID #FindStack
             Wait %EvDelay
             ExEvent DropG #CharPosX #CharPosY #CharPosZ
             Wait %EvDelay
         }
        gosub ConsolidateOre %IronCol
        gosub ConsolidateOre %DullCopperCol
        gosub ConsolidateOre %ShadowCol
        gosub ConsolidateOre %CopperCol
        ;gosub ConsolidateOre %BronzeCol
        ;gosub ConsolidateOre %GoldCol
        ;gosub ConsolidateOre %AgapiteCol
        ;gosub ConsolidateOre %VeriteCol
        ;gosub ConsolidateOre %ValoriteCol

         FindItem %Forge G_2
         Set #LTargetID #FindID
         Set #LTargetKind 1

         Set %SmeltTrigger #True
         While %SmeltTrigger = #True
         {
             FindItem %Ore G_2
             For #FindIndex 1 #FindCnt
             {
                 If #FindCnt <> 0
                 {
                     If #FindStack = 1
                     {
                         ExEvent Drag #FindID #FindStack
                         Wait 15
                         ExEvent DropC %PackHorse 0 0
                         Wait 15
                     }
                     Else
                     {
                         Set #LObjectID #FindID
                         Event Macro 17 0
                         Wait 10
                         Event Macro 22 0
                         Wait 10
                     }
                 }
             }
             GoSub OrganizeIngots
             FindItem %Ore G_2
             If #FindCnt = 0
             {
                 Event Macro 1 0 All Follow Me
                 Return
             }
         }
         Else
             Display There are no forges near you.
    }
    Return
    
Sub OrganizeIngots
    Set %Row1 0
    Set %Row2 75

    Set %Col1 0
    Set %Col2 40
    Set %Col3 60
    Set %Col4 80
    Set %Col5 100

    FindItem %Ingots C_ , #BackpackID
    Wait 5
    For #FindIndex 1 #FindCnt
    {
        If #FindCol = %IronCol
        {
            Set %IngotX %Col1
            Set %IngotY %Row1
        }
        If #FindCol = %DullCopperCol
        {
            Set %IngotX %Col2
            Set %IngotY %Row1
        }
        If #FindCol = %ShadowCol
        {
            Set %IngotX %Col3
            Set %IngotY %Row1
        }
        If #FindCol = %CopperCol
        {
            Set %IngotX %Col4
            Set %IngotY %Row1
        }
        If #FindCol = %BronzeCol
        {
            Set %IngotX %Col1
            Set %IngotY %Row2
        }
        If #FindCol = %GoldCol
        {
            Set %IngotX %Col2
            Set %IngotY %Row2
        }
        If #FindCol = %AgapiteCol
        {
            Set %IngotX %Col3
            Set %IngotY %Row2
        }
        If #FindCol = %VeriteCol
        {
            Set %IngotX %Col4
            Set %IngotY %Row2
        }
        If #FindCol = %ValoriteCol
        {
            Set %IngotX %Col5
            Set %IngotY %Row2
        }

        ExEvent Drag #FindID #FindStack
        Wait %EvDelay
        ExEvent DropC %ToolBag %IngotX %IngotY
        Wait %EvDelay
    }
    Return
    
Sub 8x8
    Set %x #CharPosX % 8
    Set %y #CharPosY % 8
    Menu Set XLoc %x
    Menu Set YLoc %y
    Return